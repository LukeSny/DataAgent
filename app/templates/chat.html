<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chatbot</title>
</head>
<body>
    <h1>Chat with a Bot</h1>
    <form method="post">
        {% csrf_token %}
        <label for="bot">Select a bot:</label>
        <select name="bot" id="bot">
            <option value="openai" {% if selected_bot == 'openai' %}selected{% endif %}>OpenAI (GPT-4o)</option>
            <option value="anthropic" {% if selected_bot == 'anthropic' %}selected{% endif %}>Anthropic (Claude)</option>
            <option value="perplexity" {% if selected_bot == 'perplexity' %}selected{% endif %}>Perplexity (LLaMA)</option>
        </select>
        <br><br>

        <label for="message">Your message:</label><br>
        <textarea name="message" id="message" rows="4" cols="50">{{ user_message }}</textarea><br><br>
        <input type="submit" value="Send">
    </form>

    {% if bot_response %}
        <h3>Bot Response:</h3>
        <p>{{ bot_response }}</p>
    {% endif %}

    {% if matches %}
        <h3>Retrieved Documents:</h3>
        <ul>
            {% for path, content in matches %}
                <li>
                    <strong>Source:</strong> 
                    <a href="#" class="source-link" data-source="{{ path|urlencode }}" id="link-{{ forloop.counter }}">
                        {{ path }}
                    </a>
                    <br>
                    <strong>Relevent Content:</strong>
                    <pre style="white-space: pre-wrap; max-height: 200px; overflow-y: auto; border: 1px solid #ccc; padding: 8px;">{{ content }}</pre>
                    <br>
                    <div id="content-{{ forloop.counter }}" 
                         style="display:none; white-space: pre-wrap; max-height: 200px; overflow-y: auto; border: 1px solid #ccc; padding: 8px;">
                        <!-- Content will be loaded here on click -->
                    </div>
                </li>
            {% endfor %}
        </ul>
    {% endif %}

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const links = document.querySelectorAll('.source-link');

            links.forEach((link, index) => {
                link.addEventListener('click', async (e) => {
                    e.preventDefault();
                    const sourcePath = decodeURIComponent(link.dataset.source);
                    const contentDiv = document.getElementById(`content-${index + 1}`);

                    if (contentDiv.style.display === 'block') {
                        // Hide if already shown
                        contentDiv.style.display = 'none';
                        return;
                    }

                    if (!contentDiv.textContent.trim()) {
                        // Fetch content if not loaded
                        try {
                            const response = await fetch(`/get_file_content/?source=${encodeURIComponent(sourcePath)}`);
                            if (!response.ok) throw new Error('Network response was not ok');
                            const data = await response.json();
                            const prettyJson = JSON.stringify(data, null, 2);
                            contentDiv.textContent = prettyJson;
                        } catch (error) {
                            contentDiv.textContent = 'Failed to load content.';
                            console.error(error);
                        }
                    }

                    contentDiv.style.display = 'block';
                });
            });
        });
    </script>
</body>
</html>

